// Pieuvre â€” Vue Snapshots
//
// Historique et rollback.

import { Tokens } from "../tokens.slint";
import { PrimaryButton, SecondaryButton, DangerButton } from "../components/button.slint";
import { StatusBadge, BadgeVariant } from "../components/status_badge.slint";

// Ligne de snapshot
component SnapshotRow inherits Rectangle {
    in property <string> id: "uuid";
    in property <string> timestamp: "2024-01-01 12:00";
    in property <string> description: "Snapshot";
    in property <int> changes-count: 0;
    in property <bool> is-latest: false;
    callback restore;
    callback view-details;
    callback delete;
    
    height: 72px;
    background: ta.has-hover ? Tokens.surface-hover : Tokens.surface-color;
    border-radius: Tokens.radius-md;
    
    animate background { duration: Tokens.anim-fast; }
    
    HorizontalLayout {
        padding: Tokens.spacing-md;
        spacing: Tokens.spacing-md;
        alignment: space-between;
        
        // Left: Info
        VerticalLayout {
            spacing: Tokens.spacing-xs;
            alignment: center;
            horizontal-stretch: 1;
            
            HorizontalLayout {
                spacing: Tokens.spacing-sm;
                
                Text {
                    text: description;
                    color: Tokens.text-primary;
                    font-size: Tokens.font-size-md;
                    font-weight: 500;
                }
                
                if is-latest: StatusBadge {
                    label: "Dernier";
                    variant: BadgeVariant.info;
                }
            }
            
            HorizontalLayout {
                spacing: Tokens.spacing-md;
                
                Text {
                    text: "ðŸ“… " + timestamp;
                    color: Tokens.text-secondary;
                    font-size: Tokens.font-size-xs;
                }
                
                Text {
                    text: "ðŸ”§ " + changes-count + " modifications";
                    color: Tokens.text-muted;
                    font-size: Tokens.font-size-xs;
                }
                
                Text {
                    text: "ID: " + id;
                    color: Tokens.text-muted;
                    font-size: Tokens.font-size-xs;
                    overflow: elide;
                }
            }
        }
        
        // Right: Actions
        HorizontalLayout {
            spacing: Tokens.spacing-sm;
            alignment: end;
            
            SecondaryButton {
                label: "DÃ©tails";
                clicked => { view-details(); }
            }
            
            PrimaryButton {
                label: "Restaurer";
                clicked => { restore(); }
            }
            
            Rectangle {
                width: 40px;
                height: 40px;
                border-radius: Tokens.radius-md;
                background: del-ta.has-hover ? Tokens.error-color : transparent;
                
                Text {
                    text: "ðŸ—‘";
                    color: del-ta.has-hover ? Tokens.background-color : Tokens.text-muted;
                    font-size: Tokens.font-size-md;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                
                del-ta := TouchArea {
                    clicked => { delete(); }
                    mouse-cursor: pointer;
                }
            }
        }
    }
    
    ta := TouchArea {
        mouse-cursor: pointer;
    }
}

export component SnapshotsView inherits Rectangle {
    in property <int> snapshot-count: 0;
    
    // Snapshot 1 (latest)
    in property <string> snap1-id: "";
    in property <string> snap1-timestamp: "";
    in property <string> snap1-description: "";
    in property <int> snap1-changes: 0;
    
    // Snapshot 2
    in property <string> snap2-id: "";
    in property <string> snap2-timestamp: "";
    in property <string> snap2-description: "";
    in property <int> snap2-changes: 0;
    
    // Snapshot 3
    in property <string> snap3-id: "";
    in property <string> snap3-timestamp: "";
    in property <string> snap3-description: "";
    in property <int> snap3-changes: 0;
    
    callback create-snapshot;
    callback restore-latest;
    callback restore-snapshot(string);
    callback delete-snapshot(string);
    
    background: Tokens.background-color;
    
    Flickable {
        viewport-height: content.preferred-height;
        
        content := VerticalLayout {
            padding: Tokens.spacing-lg;
            spacing: Tokens.spacing-lg;
            
            // Actions
            HorizontalLayout {
                spacing: Tokens.spacing-md;
                
                PrimaryButton {
                    label: "ðŸ“¸ CrÃ©er Snapshot";
                    clicked => { create-snapshot(); }
                }
                
                SecondaryButton {
                    label: "â†© Restaurer dernier";
                    enabled: snapshot-count > 0;
                    clicked => { restore-latest(); }
                }
            }
            
            // Info card
            Rectangle {
                background: Tokens.surface-color;
                border-radius: Tokens.radius-md;
                
                HorizontalLayout {
                    padding: Tokens.spacing-md;
                    spacing: Tokens.spacing-lg;
                    
                    Text {
                        text: "â„¹";
                        font-size: Tokens.font-size-lg;
                        vertical-alignment: center;
                    }
                    
                    Text {
                        text: "Les snapshots sont crÃ©Ã©s automatiquement avant chaque modification.\nUtilisez-les pour revenir Ã  un Ã©tat prÃ©cÃ©dent en cas de problÃ¨me.";
                        color: Tokens.text-secondary;
                        font-size: Tokens.font-size-sm;
                        wrap: word-wrap;
                    }
                }
            }
            
            // Snapshots list
            if snapshot-count == 0: Rectangle {
                height: 200px;
                background: Tokens.surface-color;
                border-radius: Tokens.radius-lg;
                
                VerticalLayout {
                    alignment: center;
                    spacing: Tokens.spacing-md;
                    
                    Text {
                        text: "ðŸ“­";
                        font-size: 48px;
                        horizontal-alignment: center;
                    }
                    
                    Text {
                        text: "Aucun snapshot";
                        color: Tokens.text-secondary;
                        font-size: Tokens.font-size-lg;
                        horizontal-alignment: center;
                    }
                    
                    Text {
                        text: "Les snapshots seront crÃ©Ã©s lors de l'application d'optimisations.";
                        color: Tokens.text-muted;
                        font-size: Tokens.font-size-sm;
                        horizontal-alignment: center;
                    }
                }
            }
            
            // Dynamic snapshots list
            if snapshot-count > 0: VerticalLayout {
                spacing: Tokens.spacing-sm;
                
                // Snapshot 1 (latest)
                if root.snap1-id != "": SnapshotRow {
                    id: root.snap1-id;
                    timestamp: root.snap1-timestamp;
                    description: root.snap1-description;
                    changes-count: root.snap1-changes;
                    is-latest: true;
                    restore => { restore-snapshot(root.snap1-id); }
                    delete => { delete-snapshot(root.snap1-id); }
                }
                
                // Snapshot 2
                if snapshot-count >= 2 && root.snap2-id != "": SnapshotRow {
                    id: root.snap2-id;
                    timestamp: root.snap2-timestamp;
                    description: root.snap2-description;
                    changes-count: root.snap2-changes;
                    is-latest: false;
                    restore => { restore-snapshot(root.snap2-id); }
                    delete => { delete-snapshot(root.snap2-id); }
                }
                
                // Snapshot 3
                if snapshot-count >= 3 && root.snap3-id != "": SnapshotRow {
                    id: root.snap3-id;
                    timestamp: root.snap3-timestamp;
                    description: root.snap3-description;
                    changes-count: root.snap3-changes;
                    is-latest: false;
                    restore => { restore-snapshot(root.snap3-id); }
                    delete => { delete-snapshot(root.snap3-id); }
                }
            }
        }
    }
}
