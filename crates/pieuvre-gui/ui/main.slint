// Pieuvre — Main Window
//
// Point d'entrée UI principal.

import { Tokens } from "tokens.slint";
import { AppState, SystemInfo, ProfileConfig } from "globals.slint";
import { Toast } from "components/toast.slint";
import { BadgeVariant } from "components/status_badge.slint";

import { Sidebar } from "views/sidebar.slint";
import { Header } from "views/header.slint";
import { StatusBar } from "views/statusbar.slint";
import { DashboardView } from "views/dashboard.slint";
import { AuditView } from "views/audit.slint";
import { OptimizationsView } from "views/optimizations.slint";
import { ProfilesView } from "views/profiles.slint";
import { SnapshotsView } from "views/snapshots.slint";
import { SettingsView } from "views/settings.slint";

export component MainWindow inherits Window {
    title: "Pieuvre - Windows System Optimizer";
    min-width: 1024px;
    min-height: 768px;
    background: Tokens.background-color;
    
    // Callbacks pour le code Rust
    callback run-audit;
    callback apply-optimizations(bool);
    callback load-profile(string);
    callback restore-snapshot(string);
    callback create-snapshot;
    callback save-settings;
    
    // System info (set from Rust)
    in-out property <string> sys-os-version: "Windows 11";
    in-out property <string> sys-build-number: "22631";
    in-out property <string> sys-hostname: "DESKTOP";
    in-out property <string> sys-cpu-name: "Unknown CPU";
    in-out property <int> sys-cpu-cores: 8;
    in-out property <int> sys-ram-gb: 16;
    in-out property <string> sys-gpu-name: "Unknown GPU";
    in-out property <bool> sys-is-laptop: false;
    
    // Service states (set from Rust after audit)
    in-out property <bool> svc-diagtrack: true;
    in-out property <bool> svc-dmwappush: true;
    in-out property <bool> svc-wersvc: true;
    in-out property <bool> svc-sysmain: true;
    in-out property <bool> svc-wsearch: true;
    in-out property <bool> svc-bits: true;
    in-out property <bool> svc-wuauserv: true;
    in-out property <bool> svc-mapbroker: true;
    in-out property <int> services-total: 8;
    in-out property <int> services-running: 6;
    
    // Telemetry state (from audit)
    in-out property <bool> telemetry-diagtrack: true;
    in-out property <int> telemetry-level: 3;  // 0=Off, 1=Basic, 2=Enhanced, 3=Full
    in-out property <bool> telemetry-advertising-id: true;
    in-out property <bool> telemetry-location: true;
    
    // Performance state (from audit)
    in-out property <string> timer-resolution: "15.6ms";
    in-out property <string> power-plan: "Balanced";
    in-out property <bool> msi-mode: false;
    
    // Profiles counts (from config TOML)
    in-out property <int> profile-gaming-count: 0;
    in-out property <int> profile-privacy-count: 0;
    in-out property <int> profile-workstation-count: 0;
    
    // Toast state
    in-out property <string> toast-message: "";
    in-out property <BadgeVariant> toast-variant: BadgeVariant.info;
    in-out property <bool> toast-visible: false;
    
    // Audit state
    in-out property <bool> is-auditing: false;
    in-out property <float> audit-progress: 0.0;
    
    // Optimizations state
    in-out property <int> selected-optimizations: 0;
    in-out property <bool> is-applying: false;
    
    // Snapshots state
    in-out property <int> snapshot-count: 0;
    
    // Snapshot 1 (latest)
    in-out property <string> snap1-id: "";
    in-out property <string> snap1-timestamp: "";
    in-out property <string> snap1-description: "";
    in-out property <int> snap1-changes: 0;
    
    // Snapshot 2
    in-out property <string> snap2-id: "";
    in-out property <string> snap2-timestamp: "";
    in-out property <string> snap2-description: "";
    in-out property <int> snap2-changes: 0;
    
    // Snapshot 3
    in-out property <string> snap3-id: "";
    in-out property <string> snap3-timestamp: "";
    in-out property <string> snap3-description: "";
    in-out property <int> snap3-changes: 0;
    
    // Layout principal
    HorizontalLayout {
        // Sidebar
        Sidebar {
            navigate(view) => {
                AppState.current-view = view;
            }
        }
        
        // Main content area
        VerticalLayout {
            horizontal-stretch: 1;
            
            // Header
            Header {
                refresh-clicked => {
                    run-audit();
                }
            }
            
            // Content area
            Rectangle {
                vertical-stretch: 1;
                background: Tokens.background-color;
                
                // View switcher
                if AppState.current-view == "dashboard": DashboardView {
                    os-version: sys-os-version;
                    build-number: sys-build-number;
                    hostname: sys-hostname;
                    cpu-name: sys-cpu-name;
                    cpu-cores: sys-cpu-cores;
                    ram-gb: sys-ram-gb;
                    gpu-name: sys-gpu-name;
                    is-laptop: sys-is-laptop;
                    telemetry-diagtrack: telemetry-diagtrack;
                    telemetry-level: telemetry-level;
                    timer-resolution: timer-resolution;
                    power-plan: power-plan;
                    msi-mode: msi-mode;
                    run-audit => { run-audit(); }
                    open-optimizations => { AppState.current-view = "optimizations"; }
                }
                
                if AppState.current-view == "audit": AuditView {
                    is-auditing: is-auditing;
                    audit-progress: audit-progress;
                    cpu-name: sys-cpu-name;
                    cpu-cores: sys-cpu-cores;
                    ram-gb: sys-ram-gb;
                    gpu-name: sys-gpu-name;
                    is-laptop: sys-is-laptop;
                    svc-diagtrack: svc-diagtrack;
                    svc-dmwappush: svc-dmwappush;
                    svc-wersvc: svc-wersvc;
                    svc-sysmain: svc-sysmain;
                    svc-wsearch: svc-wsearch;
                    svc-bits: svc-bits;
                    svc-wuauserv: svc-wuauserv;
                    svc-mapbroker: svc-mapbroker;
                    services-total: services-total;
                    services-running: services-running;
                    run-audit => { run-audit(); }
                }
                
                if AppState.current-view == "optimizations": OptimizationsView {
                    selected-count: selected-optimizations;
                    is-applying: is-applying;
                    apply-clicked(dry-run) => { apply-optimizations(dry-run); }
                }
                
                if AppState.current-view == "profiles": ProfilesView {
                    profile-gaming-count: profile-gaming-count;
                    profile-privacy-count: profile-privacy-count;
                    profile-workstation-count: profile-workstation-count;
                    load-profile(name) => { load-profile(name); }
                }
                
                if AppState.current-view == "snapshots": SnapshotsView {
                    snapshot-count: snapshot-count;
                    snap1-id: snap1-id;
                    snap1-timestamp: snap1-timestamp;
                    snap1-description: snap1-description;
                    snap1-changes: snap1-changes;
                    snap2-id: snap2-id;
                    snap2-timestamp: snap2-timestamp;
                    snap2-description: snap2-description;
                    snap2-changes: snap2-changes;
                    snap3-id: snap3-id;
                    snap3-timestamp: snap3-timestamp;
                    snap3-description: snap3-description;
                    snap3-changes: snap3-changes;
                    create-snapshot => { create-snapshot(); }
                    restore-snapshot(id) => { restore-snapshot(id); }
                }
                
                if AppState.current-view == "settings": SettingsView {
                    save-settings => { save-settings(); }
                }
            }
            
            // Status bar
            StatusBar {}
        }
    }
    
    // Toast overlay
    Toast {
        message: toast-message;
        variant: toast-variant;
        is-visible: toast-visible;
        dismissed => { toast-visible = false; }
    }
}
